<!DOCTYPE html>
<html lang="en">
<head>
    <title>Water Tank</title>
</head>
<body id="body" spellcheck="false">
    <style>
        body {
            overflow: hidden;
        }
    </style>

    <span id="attrib0" data-type="channel" data-name="Source" data-default="" />
    <span id="TBtooltip" data-default="Water Tank Level" />
    <span id="ontop" data-default="true" />

    <div id="group" >
        <svg id="widget" width="100" height="100" style="position: absolute; left: 0px; top: 0px; z-index:4">
            <g id="svgGroup" style="position: absolute; left: 0px; top: 0px;">
                <g id="noScale">
                </g>
                <g id="scale">
                    <ellipse ry="6.27954" rx="40.733" cy="88.134" cx="50.267" stroke-width="0" stroke="#4796e5" fill="#4796e5" />
                    <rect height="77.1728" width="96.9383" y="9.7538" x="1.56271" stroke-opacity="0" stroke="#000000" fill-opacity="0.2" fill="#000000"/>
                    <path d="m2,87c0,15 96,15 96,0" stroke="#4c4c4c" fill-opacity="0.2" fill="#000000" />
                    <path d="m2,74c0,15 96,15 96,0" stroke="#4c4c4c" fill="transparent" />
                    <path d="m2,61c0,15 96,15 96,0" stroke="#4c4c4c" fill="transparent" />
                    <path d="m2,47c0,15 96,15 96,0" stroke="#4c4c4c" fill="transparent" />
                    <path d="m2,9c0,15 96,15 96,0" stroke="#4c4c4c" fill="transparent" />
                    <g>
                        <line y2="37.0464" x2="99.0101" y1="34.9107" x1="98.2983" stroke="#4c4c4c" fill="none" />
                        <line y2="46.3855" x2="98.984" y1="36.7348" x1="98.9841" stroke="#4c4c4c" fill="none" />
                        <line y2="46.0464" x2="99.0101" y1="47.9107" x1="98.2983" stroke="#4c4c4c" fill="none" />
                    </g>
                    <g>
                        <line y2="50.6209" x2="99.0351" y1="48.4852" x1="98.324" stroke="#4c4c4c" fill="none"/>
                        <line y2="59.96" x2="99.0091" y1="50.3093" x1="99.0091" stroke="#4c4c4c" fill="none" />
                        <line y2="59.6209" x2="99.0351" y1="61.4852" x1="98.324" stroke="#4c4c4c" fill="none" />
                    </g>
                    <g>
                        <line y2="63.2476" x2="99.0131" y1="61.1119" x1="98.3021" stroke="#4c4c4c" fill="none" />
                        <line y2="72.5867" x2="98.9871" y1="62.936" x1="98.9871" stroke="#4c4c4c" fill="none" />
                        <line y2="72.2476" x2="99.0131" y1="74.1119" x1="98.3021" stroke="#4c4c4c" fill="none" />
                    </g>
                    <g>
                        <line y2="76.3624" x2="99.0131" y1="74.2267" x1="98.3021" stroke="#4c4c4c" fill="none" />
                        <line y2="85.7015" x2="98.9871" y1="76.0508" x1="98.9871" stroke="#4c4c4c" fill="none" />
                        <line y2="85.3624" x2="99.0131" y1="87.2267" x1="98.3021" stroke="#4c4c4c" fill="none" />
                    </g>
                    <g>
                        <line y2="24.3593" x2="98.8969" y1="22.2236" x1="98.185" stroke="#4c4c4c" fill="none" />
                        <line y2="33.6984" x2="98.8709" y1="24.0477" x1="98.871" stroke="#4c4c4c" fill="none" />
                        <line y2="33.3593" x2="98.8969" y1="35.2236" x1="98.185" stroke="#4c4c4c" fill="none" />
                    </g>
                    <g>
                        <line y2="11.5448" x2="98.8969" y1="9.4091" x1="98.185" stroke="#4c4c4c" fill="none" />
                        <line y2="20.8839" x2="98.8709" y1="11.2332" x1="98.871" stroke="#4c4c4c" fill="none" />
                        <line y2="20.5448" x2="98.8969" y1="22.4091" x1="98.185" stroke="#4c4c4c" fill="none" />
                    </g>
                    <path d="m2.1122,21.82935c0,15.0624 96.0367,15.0624 96.0367,0" stroke="#4c4c4c" fill="transparent" />
                    <path d="m1.93421,34.82185c0,15.0624 96.03669,15.0624 96.03669,0" stroke="#4c4c4c" fill="transparent" />
                    <g transform="rotate(179.497 1.72036 16.799)">
                        <line y2="12.4347" x2="2.07637" y1="10.299" x1="1.36437" stroke="#4c4c4c" fill="none" />
                        <line y2="21.7738" x2="2.05036" y1="12.1231" x1="2.05036" stroke="#4c4c4c" fill="none" />
                        <line y2="21.4347" x2="2.07637" y1="23.299" x1="1.36437" stroke="#4c4c4c" fill="none" />
                    </g>
                    <g transform="rotate(179.497 1.72036 30.2858)">
                        <line y2="25.9215" x2="2.07637" y1="23.7858" x1="1.36437" stroke="#4c4c4c" fill="none" />
                        <line y2="35.2606" x2="2.05036" y1="25.6099" x1="2.05036" stroke="#4c4c4c" fill="none" />
                        <line y2="34.9215" x2="2.07637" y1="36.7858" x1="1.36437" stroke="#4c4c4c" fill="none" />
                    </g>
                    <g transform="rotate(179.497 1.80915 42.2995)">
                        <line y2="37.9351" x2="2.16536" y1="35.7994" x1="1.45337" stroke="#4c4c4c" fill="none" />
                        <line y2="47.2742" x2="2.13937" y1="37.6235" x1="2.13937" stroke="#4c4c4c" fill="none" />
                        <line y2="46.9351" x2="2.16536" y1="48.7994" x1="1.45337" stroke="#4c4c4c" fill="none" />
                    </g>
                    <g transform="rotate(179.497 1.91496 55.3139)">
                        <line y2="50.9497" x2="2.27137" y1="48.814" x1="1.55937" stroke="#4c4c4c" fill="none" />
                        <line y2="60.2888" x2="2.24537" y1="50.6381" x1="2.24537" stroke="#4c4c4c" fill="none" />
                        <line y2="59.9497" x2="2.27137" y1="61.814" x1="1.55937" stroke="#4c4c4c" fill="none" />
                    </g>
                    <g transform="rotate(179.497 1.83158 68.4622)">
                        <line y2="64.098" x2="2.18737" y1="61.9623" x1="1.47537" stroke="#4c4c4c" fill="none" />
                        <line y2="73.4371" x2="2.16137" y1="63.7864" x1="2.16137" stroke="#4c4c4c" fill="none" />
                        <line y2="73.098" x2="2.18737" y1="74.9623" x1="1.47537" stroke="#4c4c4c" fill="none" />
                    </g>
                    <g transform="rotate(179.497 1.96524 81.0097)">
                        <line y2="76.6454" x2="2.32137" y1="74.5097" x1="1.60936" stroke="#4c4c4c" fill="none" />
                        <line y2="85.9845" x2="2.29536" y1="76.3338" x1="2.29536" stroke="#4c4c4c" fill="none" />
                        <line y2="85.6454" x2="2.32137" y1="87.5097" x1="1.60936" stroke="#4c4c4c" fill="none" />
                    </g>
                    <path d="m1.99704,2.60239c0,9.8366 96.21108,9.8366 96.21108,0" transform="rotate(179.75 50.1026 6.29112)" stroke="#4c4c4c" fill-opacity="0.2" fill="#000000"/>                                      
                </g>
            </g>
        </svg>
        <svg id="waterell" style="position: absolute; left: 0px; top: 0px; z-index:3">
            <ellipse id="waterellSvg" ry="6" rx="41" cy="86" cx="50" stroke="#005fbf" fill="#9dc2e8" />
        </svg>
        <svg id="text" style="position: absolute; left: 0px; top: 0px; z-index:5">
            <style type="text/css">
                text {
                    font-family: "Helvetica Neue", Arial, Helvetica, sans-serif;
                    font-weight: normal;
                    font-style: normal;
                    font-size: 20px;
                    text-align: center;
                    pointer-events: none;
                }
            </style>
            <text id="numVal" x="36" y="58" fill="rgb(255,255,255)">0%</text>
        </svg>
        <div id="waterrec" style="position: absolute; left: 9px; width: 82px; top: 86px; height: 1px; background-color: #4796e5; z-index:2" />
    </div>

    <script>
        // Initialize widget framework API
        var fw;
        function widgetLoad(myName) {
            fw = new parent.widgetAPI(myName);                                  // widget framework object
        }

        var numID = document.getElementById("numVal");		        // id text field
        var svgText = document.getElementById("text");		        // id of text SVG
        var waterell = document.getElementById("waterell");		        // id of text SVG
        var waterrec = document.getElementById("waterrec");		        // id of text SVG
        var level = 0;
        var oldVal = 0;

        // Widget specific startup actions for dashboard. Return "OK" if startup OK else return an error string
        function dashStart(mode) {
            fw.func("setTooltip", "Water Tank Level");
            return "OK";
        }

        // Widget specific startup actions when first created by dropping in design mode. Return "OK" if startup OK else return an error string
        function newWidget(mode) {
            return dashStart();
        }

        // Widget specific startup actions for toolbox. Return "OK" if startup OK else return an error string
        function toolStart(mode) {
            svgText.style.setProperty("display", "none");
            return "OK"
        }

        function startDesign() {                                // called when switching to design mode
            return true;
        }

        function menuUpdate() {                                 // called when widget option menu requires updating
            return true;
        }

        function endDesign() {                                  // called when switching from design mode
            return true;
        }

        function clicked() {
            //adjustLevel(80);
        }

        function toolboxStart() {           // called when loaded in toolbox
        }

        function scale(scaleX, scaleY) {                        // manage scaling
            numID.setAttribute("transform", "scale(" + scaleX + "," + scaleY + ")");
            waterellSvg.setAttribute("transform", "scale(" + scaleX + "," + scaleY + ")");
            waterrec.style.setProperty("top", 87 * fw.scaleY + "px");
            waterrec.style.setProperty("left", 9 * fw.scaleX + "px");
            waterrec.style.setProperty("width", 82 * fw.scaleX + "px");
            return true;
        }

        function feed(channel, scope, data) {                   // Called for incoming channel events
            var numeric = parseInt(data);
            if (isNaN(numeric)) return;
            switch (scope.toLowerCase()) {
                case "level":
                    if (channel.toLowerCase() === fw.attribs[0].value.split("/")[2].toLowerCase()) return adjustLevel(numeric);
                    break;
            }
            return true;
        }

        function ini(channel, scope, data) {                    // Called to set initial channel status
            switch (scope.toLowerCase()) {
                case "level":
                    setTimeout(feed, 500, channel, scope, data);           // delay so automation can be seen during loading
                    break;
            }
        }

        // animate tank level changes
        function adjustLevel(newVal) {
            if (oldVal !== newVal) {
                var ratio = +newVal * 0.76;

                numID.textContent = newVal.toString() + "%";                 
                numID.setAttribute("x", (document.getElementById("widget").clientWidth / 2 - numID.getBBox().width / 2));       // Adjust number to be center
                
                waterell.style.setProperty('transition', 'top ' + Math.abs(+newVal - oldVal) / 77 + 's cubic-bezier(0.44, 0, 0.68, 1.20)');
                waterrec.style.setProperty('transition', 'height ' + Math.abs(+newVal - oldVal) / 77 + 's cubic-bezier(0.44, 0, 0.68, 1.20), top ' + Math.abs(+newVal - oldVal) / 77 + 's cubic-bezier(0.44, 0, 0.68, 1.20)');
                waterell.style.setProperty("top", (-1 * ratio * fw.scaleY) + "px");              // range max: 9 , min: 86
                waterrec.style.setProperty("top", (87 - ratio) * fw.scaleY + "px");              // range max:9 , min: 86
                waterrec.style.setProperty("height", ratio * fw.scaleY + "px");              // range max:77 , min: 0

                oldVal = +newVal;
            }
        }

</script>
</body>
</html>